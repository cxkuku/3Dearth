# jm-webview

js 和 native app 交互库

> 参考：
>
> APP统一跳转协议文档 http://cf.jd.com/pages/viewpage.action?pageId=73644612

### 线上DEMO

基本 http://beta-h5.m.jd.com/demo/jm-webview/index.html

导航相关 http://beta-h5.m.jd.com/demo/jm-webview/navi.html

其他 http://beta-h5.m.jd.com/demo/jm-webview/etc.html

V6.4 新协议： http://beta-h5.m.jd.com/demo/jm-webview/webview640.html

> 另外有一个过往的webview协议demo仓库：http://git.jd.com/jmfe-active/webview-demo

### 安装

```
$ jnpm install @jmfe/jm-webview --save
```

### 测试

```
$ npm test
```

### 使用

某些调用可能需要设置 sourceType 和 sourceValue 的值，这个可以通过 extra 参数来进行设置， 比如：

```js
webview.toProduct(123, {
	sourceType: 'h5',
	sourceValue: 123
});
```

部分新的 API 可能未及时支持，所以暴露 nativeCall 方法支持直接调用， 比如 toProduct 也可以写成：

```js
webview.nativeCall('virtual', { 
	category: 'jump', 
	des: 'productDetail',
	skuId: 123,
	sourceType: 'h5',
	sourceValue: 123
});
```

### API

#### 基础


- nativeCall(name, params, [shema])
- buildSchema(name, params, [shema])

- toHome()
- toProduct(id, [extra]) 
- toLogin([returnUrl])
- toCouponCenter([extra])
- toOrderList([extra])
- toSecKill([extra])
- toShop(id, [extra])
- openNewWebView(url)

- getHomeSchema()
- getProductSchema(id, [extra])
- getCouponCenterSchema([extra])
- getOrderListSchema([extra])
- getSecKillSchema([extra])
- getShopSchema(id, [extra])

#### 发现频道

- toDiscovery([extra])
- toArticle(id, [extra])
- toAuthor(id, [extra])
- toInventory([extra])
- toInventoryDetail(id, [extra])

- getDiscoverySchema([extra])
- getArticleSchema(id, [extra])
- getAuthorSchema(id, [extra])
- getInventorySchema([extra])
- getInventoryDetailSchema(id, [extra])

### 购物车

- toCart([extra])
- refreshCart()
- showCartButton()

- getCartSchema([extra])

#### 分享

- callSharePane(params)
- setShareInfo(params)
- sendDirectShare(params)

#### 直播

- toLiveCastList([type])
- toLiveCastPreview(id, [type])
- toLiveCastRoom(id, [type])

- getLiveCastListSchema([type])
- getLiveCastPreviewSchema(id, [type])
- getLiveCastRoomSchema(id, [type])

### 导航栏

- setNaviBackground(options) 设置导航栏背景
	- {string} `options.naviIcon` 必选，icon颜色类型 '1'代表灰色导航栏图标（也即默认值，适用于浅色背景），'2'代表白色导航栏图标，适用于深色背景
	- {string} `options.backgroundColor`  可选，设置背景颜色 e.g.'#3a3a3a' 与 options.pic二选一
	- {string} `options.pic` 可选，设置背景图片url 必须是https协议 'https://m.360buyimg.com/babel/jfs/t4036/283/2146564148/19349/f7389255/58a4184aNdb067a60.jpg'

- configBtnClear() 兼容6.1以上及以下，清除导航上按钮的配置，归位默认设置，在调用配置方法前使用。

- configBtnSet(options) 5.1自定义导航栏按钮
	- {enum} `options.type` 'homepage', 'search', 'calendar', 'cart', 'message', 'custom'
	- {enum} `options.display` 'show', 'hide'
	- {enum} `options.position` 'outside', 'inside'
	- {string} `options.icon` 图片url,e.g. https://img30.360buyimg.com/img/jfs/t2908/97/887995636/1494/daa390f/572aecfcN98a01bba.png
	- {string} `options.title` 按钮名称，e.g. 满意度调查
	- {string} `options.jump` 跳转url，e.g. 

- configBtnSince610(options) 6.1自定义导航栏按钮
	- {Object} `options[type]`  type是类型名，app内置的有'homepage', 'search', 'calendar', 'cart', 'message', 'custom'。另外还可以自定义类型名，最多2个。每个type对应一个参数对象，具体属性可以参考 `configBtnSet`的options
	
```js
	var optons = {
    	homepage: {
           	type: 'homepage',
            display: 'show',
            position: 'inside',
            title: '首页',
            icon: 'https://img30.360buyimg.com/img/jfs/t2908/97/887995636/1494/daa390f/572aecfcN98a01bba.png'
            jump: 'https://m.jd.com'
    }
```
- showCloseBtn() 显示Webview左上角关闭按钮及逻辑
			
- enableTransparent(options) 设置透明导航栏
	- {string} options.blackImg 图片url https开头，与黑色icon对应
	- {string} options.whiteImg 图片url https开头，与白色icon对应

- setTitle(title) 设置webview导航栏文字标题 
	- {string} `title`

- showNativeBarcodeScan(callbackName) 打开扫啊扫
	- {string} `callbackName`

- showNativeUpload() 多种相片上传

### XView

- XViewClose() 关闭XView

- XViewConfigCloseButton(closePositionX, closePositionY, closeIcon)  设置Xview关闭按钮位置及图标
	- {number} `closePositionX` 关闭按钮x坐标 0<=x<=1
	- {number} `closePositionY` 关闭按钮y坐标 0<=x<=1
	- {string} `closeIcon` 关闭按钮图片url

### 支付

- JDPaySdk_pay(pin, code, mode) 京东支付
	- {string} `pin`
	- {string} `code`
	- {string} `mode`

- JDPaySdk_pop() 关闭支付

### 其他

- saveImageToPhoteAlbum(imgUrl, callBackName, callBackId)
	- {string} `imgUrl` - 图片url
	- {string} `callBackName` - 全局回调函数名
	- {string} `callBackId` -  由H5自己生成的一个标示性字符串，这个是为了同时下载多张图片时h5进行区分，通过回调函数的参数返回给H5

- bindSocialAccountWithJsonString(channelName, callBackName) 微信QQ授权登录
	- {enum} channelName 'QQ', 'WX'
	- {string} callBackName 授权后的回调函数名，其参数是一个jsonString,属性如下：
		- {number} authPlatform 0表示QQ，1表示微信
		- {number} authResult 0表示认证失败，1表示成功，2表示用户取消
		- {string} authErrMsg 错误信息
		- {string} wxCode 用于微信
		- {string} qqOpenId 用于qq
		- {string} qqAccessToken 用于qq

- selectImage()  选择或者拍摄一张图片
	- 通过设置全局回调函数来获取图片路劲
	```javascript
		// path 是线上图片的部分url，e.ge. jfs/t5653/106/7186207599/16817/b9afa9c1/596f3242Nfad54ab6.jpg
		// 完整的图片url需要自行拼接。
		// htmlString 是当前整个页面的html字符串，暂时不知道有什么用
		window.cameraCallBack = function(path, htmlString) {
			var imgSrc = '//m.360buyimg.com/babel/' + path;
		}
	```
- closeLivesWindow() app内关闭直播小窗

- getFingerInfo(cbkFunc) 获取指纹信息
	- {string} `cbkFunc ` 全局回调方法名，回调中的参数为指纹信息 string类型

- getNavHeight(cbkFunc)获取app导航高度
	- {string} `cbkFunc` 全局回调方法名，回调中的参数为导航高度信息 string类型
	
- goWxUrl(url) 微信签约---app内打开微信并跳到指定页面
	- {string} `url` 微信内跳转的url地址

### demo 页发布

项目附带测试用的 demo 用， 可通过以下命令发布到预发服务器进行测试，最终测试页面为： http://betah5.m.jd.com/test/jm-webview/

```
$ npm run deploy:demo
```

发布前需要在项目目录下创建 `.sshpass` 文件来管理 ssh 登陆的用户名和密码， 为了安全起见，该文件不会被 commit。

.sshpass 文件格式:

```js
module.exports = {
	username: "NAME",
	password: "PASS"
};
```
